{
  "requestUrl": "/webpl3/assets/20201230110628/js/scripts/fxnet/devices/web/uilayer/viewmodels/TileTransactionSwitcherViewModel.js?v=20201230110628",
  "contentType": "application/javascript",
  "method": "GET",
  "statusCode": 200,
  "data": "ï»¿define(\r\n    'deviceviewmodels/TileTransactionSwitcherViewModel',\r\n    [\r\n        'require',\r\n        'knockout',\r\n        'handlers/general',\r\n        'helpers/KoComponentViewModel',\r\n        'Dictionary',\r\n        'managers/viewsmanager',\r\n        'devicemanagers/StatesManager',\r\n        'initdatamanagers/InstrumentsManager',\r\n        'cachemanagers/QuotesManager',\r\n        'initdatamanagers/Customer',\r\n        'modules/BuilderForInBetweenQuote',\r\n        'StateObject!Transaction',\r\n        'generalmanagers/RegistrationManager',\r\n        'managers/ChartSettingManager',\r\n        'managers/ChartLayoutSettings'\r\n    ],\r\n    function TransactionSwitcherDef(require) {\r\n        var ko = require('knockout'),\r\n            general = require('handlers/general'),\r\n            koComponentViewModel = require('helpers/KoComponentViewModel'),\r\n            dictionary = require('Dictionary'),\r\n            viewsManager = require('managers/viewsmanager'),\r\n            statesManager = require('devicemanagers/StatesManager'),\r\n            instrumentsManager = require('initdatamanagers/InstrumentsManager'),\r\n            quotesManager = require('cachemanagers/QuotesManager'),\r\n            customer = require('initdatamanagers/Customer'),\r\n            BuilderForInBetweenQuote = require('modules/BuilderForInBetweenQuote'),\r\n            stateObject = require('StateObject!Transaction'),\r\n            registrationManager = require('generalmanagers/RegistrationManager'),\r\n            chartSettingManager = require('managers/ChartSettingManager'),\r\n            chartLayoutSettings = require('managers/ChartLayoutSettings');\r\n\r\n        var TransactionSwitcherViewModel = general.extendClass(koComponentViewModel, function TransactionSwitcherClass() {\r\n            var self = this,\r\n                parent = self.parent,\r\n                data = this.Data || {},\r\n                usdCcy = 47,\r\n                transactionsList = [\r\n                    { transactionName: 'fx-component-new-deal-slip', transactionLabel: dictionary.GetItem('NewDeal', 'dialogsTitles', ' '), transactionType: eTransactionSwitcher.NewDeal },\r\n                    { transactionName: 'fx-component-new-limit', transactionLabel: dictionary.GetItem('NewLimit', 'dialogsTitles', ' '), transactionType: eTransactionSwitcher.NewLimit }\r\n                ],\r\n                stateObjectSubscriptions = [];\r\n\r\n            function init(customSettings) {\r\n                parent.init.call(self, customSettings);\r\n\r\n                chartLayoutSettings.Init();\r\n                registerInstruments();\r\n\r\n                setDefaultObservables();\r\n                setComputables();\r\n                setSubscribers();\r\n\r\n                populateInQuoteForUsdCcyToAccountCcy();\r\n            }\r\n\r\n            function setDefaultObservables() {\r\n                data.quoteForOtherCcyToAccountCcy = stateObject.set('quoteForOtherCcyToAccountCcy', ko.observable(''));\r\n                data.quoteForBaseCcyToAccountCcy = stateObject.set('quoteForBaseCcyToAccountCcy', ko.observable(''));\r\n                data.quoteForUsdCcyToAccountCcy = stateObject.set('quoteForUsdCcyToAccountCcy', ko.observable(''));\r\n                data.instrumentId = stateObject.set('selectedInstrument', ko.observable(''));\r\n                data.transactionsList = ko.observableArray(transactionsList);\r\n                data.selectedTransactionTab = ko.observable();\r\n                data.selectedTransactionTab(stateObject.update('selectedTransactionTab', {}));\r\n                stateObjectSubscriptions.push({\r\n                    unsubscribe: stateObject.subscribe('selectedTransactionTab', function (value) {\r\n                        data.selectedTransactionTab(value)\r\n                    })\r\n                });\r\n                data.isReady = ko.observable(false);\r\n            }\r\n\r\n            function setComputables() {\r\n                data.isNewDealVisible = self.createComputed(function () {\r\n                    return data.selectedTransactionTab().transactionType === eTransactionSwitcher.NewDeal;\r\n                });\r\n\r\n                data.isNewLimitVisible = self.createComputed(function () {\r\n                    return data.selectedTransactionTab().transactionType === eTransactionSwitcher.NewLimit;\r\n                });\r\n            }\r\n\r\n            function setSubscribers() {\r\n                self.subscribeTo(data.instrumentId, function (instrumentId) {\r\n                    var instrument = instrumentsManager.GetInstrument(instrumentId);\r\n                    populateInBetweenQuotes(instrument);\r\n                });\r\n\r\n                subscribeToQuotesManager();\r\n            }\r\n\r\n            function populateInBetweenQuotes(instrument) {\r\n                BuilderForInBetweenQuote.GetInBetweenQuote(instrument.otherSymbol, customer.prop.baseCcyId()).then(function (response) {\r\n                    data.quoteForOtherCcyToAccountCcy(response);\r\n                });\r\n\r\n                BuilderForInBetweenQuote.GetInBetweenQuote(instrument.baseSymbol, customer.prop.baseCcyId()).then(function (response) {\r\n                    data.quoteForBaseCcyToAccountCcy(response);\r\n                });\r\n            }\r\n\r\n            function populateInQuoteForUsdCcyToAccountCcy() {\r\n                BuilderForInBetweenQuote.GetInBetweenQuote(usdCcy, customer.prop.baseCcyId()).then(function (response) {\r\n                    data.quoteForUsdCcyToAccountCcy(response);\r\n                }).done();\r\n            }\r\n\r\n            function getTransactionTab(quote) {\r\n                var transactionType = viewsManager.GetViewArgsByKeyName(eViewTypes.vTransactionSwitcher, 'transactionType') || eTransactionSwitcher.NewDeal,\r\n                    tabToSelect = general.isDefinedType(transactionType) && general.objectContainsValue(eTransactionSwitcher, transactionType) ? transactionType : eTransactionSwitcher.NewDeal,\r\n                    isMarketClosed = statesManager.States.IsMarketClosed();\r\n\r\n                if (customer.prop.brokerAllowLimitsOnNoRates && (quote.state === eQuoteStates.Disabled || isMarketClosed)) {\r\n                    tabToSelect = eTransactionSwitcher.NewLimit;\r\n                }\r\n\r\n                return getTransactionProperties(tabToSelect);\r\n            }\r\n\r\n            function getTransactionProperties(transactionType) {\r\n                return ko.utils.arrayFirst(transactionsList, function (item) {\r\n                    return item.transactionType === transactionType;\r\n                });\r\n            }\r\n\r\n            function subscribeToQuotesManager() {\r\n                var activeChartInstrumentId = getActiveTileInstrumentId();\r\n\r\n                function updateQuote() {\r\n                    var quote = quotesManager.Quotes.GetItem(activeChartInstrumentId);\r\n\r\n                    if (!quote) {\r\n                        return;\r\n                    }\r\n\r\n                    data.instrumentId(activeChartInstrumentId);\r\n\r\n                    quotesManager.OnChange.Remove(updateQuote);\r\n\r\n                    setInitialTransactionTab(quote);\r\n                }\r\n\r\n                quotesManager.OnChange.Add(updateQuote);\r\n                updateQuote();\r\n            }\r\n\r\n            function registerInstruments() {\r\n                registrationManager.Update(eRegistrationListName.ContractQuotesTable, chartLayoutSettings.GetTileInstruments());\r\n            }\r\n\r\n            function setInitialTransactionTab(quote) {\r\n                var transactionTab = getTransactionTab(quote);\r\n                stateObject.update('selectedTransactionTab', transactionTab);\r\n                data.isReady(true);\r\n            }\r\n\r\n            function getActiveTileInstrumentId() {\r\n                var tileSettings = chartSettingManager.Chart().tileSettings || {},\r\n                    activeTileId = tileSettings.activeTileId || 0,\r\n                    activeChartSettings = chartLayoutSettings.GetSettings(activeTileId) || {};\r\n\r\n                return activeChartSettings.instrumentId;\r\n            }\r\n\r\n            function dispose() {\r\n                while (stateObjectSubscriptions.length > 0) {\r\n                    stateObjectSubscriptions.pop()\r\n                        .unsubscribe();\r\n                }\r\n                parent.dispose.call(self); // inherited from KoComponentViewModel\r\n            }\r\n\r\n            return {\r\n                init: init,\r\n                dispose: dispose,\r\n                Data: data\r\n            };\r\n        });\r\n\r\n        var createViewModel = function (params) {\r\n            var viewModel = new TransactionSwitcherViewModel();\r\n            viewModel.init(params);\r\n\r\n            return viewModel;\r\n        };\r\n\r\n        return {\r\n            viewModel: { createViewModel: createViewModel }\r\n        };\r\n    }\r\n);\r\n",
  "isBase64": false
}