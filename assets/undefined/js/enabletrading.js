define("EnableTradingConfiguration",["require","knockout","ErrorManager","StateObject!DealsTabs"],function(e){var a=e("knockout"),n=e("ErrorManager"),t=e("StateObject!DealsTabs"),i="selectedTabView"+eViewTypes.vDealsTabs,r={backOffice:{"fx-component-new-deal-slip":[{"fx-component-exec-date":{viewModel:{require:"webViewModels/BackOffice/ExecDateViewModel"},template:{require:"text!webHtml/statichtml/backoffice/exec-date.html"}}}]}},s={"fx-component-new-deal-slip":{default:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/NewDealSlipViewModel"},template:{require:"text!partial-views/web-deals-newdeal.html"}},backoffice:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/BackOffice/NewDealSlipViewModel"},template:{require:"text!webHtml/statichtml/backoffice/newdeal.html"}}},"fx-component-new-limit":{default:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/NewLimitViewModel"},template:{require:"text!partial-views/web-deals-newlimit.html"}},backoffice:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/BackOffice/NewLimitViewModel"},template:{require:"text!webHtml/statichtml/backoffice/new-limit.html"}}},"fx-component-close-deal":{default:{viewModel:{require:"webViewModels/CloseDealViewModel"},template:{require:"text!partial-views/web-deals-closedeal.html"}},backoffice:{viewModel:{require:"webViewModels/BackOffice/CloseDealViewModel"},template:{require:"text!webHtml/statichtml/BackOffice/close-deal.html"}}},"fx-component-open-deals-grid":{default:{viewModel:{require:"webViewModels/OpenDealsViewModel"},template:{require:"text!partial-views/web-deals-opendeals.html"}},backoffice:{viewModel:{require:"webViewModels/BackOffice/OpenDealsViewModel"},template:{require:"text!webHtml/statichtml/BackOffice/opened-deals.html"}}},"fx-component-edit-limit":{default:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/EditLimitViewModel"},template:{require:"text!partial-views/web-deals-editlimit.html"}},backoffice:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/BackOffice/EditLimitViewModel"},template:{require:"text!webHtml/statichtml/BackOffice/edit-limit.html"}}},"fx-component-edit-closing-limit":{default:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/EditClosingLimitViewModel"},template:{require:"text!partial-views/web-deals-editclosinglimit.html"}},backoffice:{deps:["customBindings/SpinnerField"],viewModel:{require:"webViewModels/BackOffice/EditClosingLimitViewModel"},template:{require:"text!webHtml/statichtml/BackOffice/edit-closing-limit.html"}}}};function o(){var e;t.containsKey(i)&&(e=t.get(i))()===eViewTypes.vOpenDeals&&(e(0),e(eViewTypes.vOpenDeals))}return{RegisterComponents:function(){a.components.register("fx-component-enable-trading",{viewModel:{require:"webViewModels/BackOffice/EnableTradingViewModel"},template:{require:"text!webHtml/statichtml/backoffice/enable-trading.html"}})},RegisterComponentsOnEnable:function(){Object.keys(s).forEach(function(t){var e=s[t];a.components.unregister(t),a.components.register(t,e.backoffice);var i=r.backOffice[t];i&&i.length&&i.forEach(function(e){var t=Object.keys(e)[0];a.components.isRegistered(t)||a.components.register(t,e[t])}),a.components.get(t,function(e){e||n.onError(t,"Error when preload component",eErrorSeverity.medium)})}),o()},RegisterComponentsOnDisable:function(){Object.keys(s).forEach(function(e){var t=s[e];a.components.unregister(e);var i=r.backOffice[e];i&&i.length&&i.forEach(function(e){var t=Object.keys(e)[0];a.components.unregister(t)}),a.components.register(e,t.default)}),o()}}}),define("webViewModels/BackOffice/EnableTradingViewModel",["require","knockout","KoComponentViewModel","StateObject!TradingEnabled","PermissionsModule"],function(e){var i,a=e("knockout"),n=e("PermissionsModule"),r=e("StateObject!TradingEnabled"),s="TradingEnabled",t=e("KoComponentViewModel"),o=extendClass(t,function(){var t=this.Data;return{Init:function(){e(["EnableTradingConfiguration"],function(e){i=e},function(){}),t.visible=a.observable(n.IsTradingUser()),t.enableTrading=a.observable(!1),r.subscribe(s,function(e){t.enableTrading(e)})},dispose:function(){i.RegisterComponentsOnDisable(),r.containsKey(s)&&r.unset(s)},Data:t,OnClickEnable:function(){r.update(s,!t.enableTrading()),t.enableTrading()?i.RegisterComponentsOnEnable():i.RegisterComponentsOnDisable()}}});return{viewModel:{createViewModel:function(){var e=new o;return e.Init(),e}}}}),define("webViewModels/BackOffice/ExecDateViewModel",["require","knockout","KoComponentViewModel","DialogViewModel","CacheManager","Dictionary"],function(e){var l=e("knockout"),c=e("DialogViewModel"),u=e("Dictionary"),d=e("CacheManager"),t=e("KoComponentViewModel"),i=extendClass(t,function(e){var s=this.Data,t=this,i={title:u.GetItem("EditLimitExpirationDate"),width:420,dialogClass:"fx-dialog expPopup",onCloseCallback:function(){o()}},a=/^(([0-1][0-9])|(2[0-3])):[0-5][0-9]:[0-5][0-9]$/;function n(){var e=new Date(d.ServerTime().getTime());s.valueDateStr(e.ExtractDate()),s.valueTime(e.ExtractFullTime()),s.maxValueDate(e),s.execDateTimeString(""),s.hasValueDate(!1)}function r(){return a.test(s.valueTime())}function o(){!1===s.execDateTimeString.isDirty()&&s.hasValueDate(!1)}return{Init:function(){s.valueDateStr=l.observable(),s.valueTime=l.observable(),s.maxValueDate=l.observable(),s.hasValueDate=l.observable(!1),s.execDateTimeString=l.observable("").extend({dirty:!1}),s.valueTime.extend({validation:{validator:r}}),!isNullOrUndefined(e.selectedInstrument)&&isFunctionType(e.selectedInstrument)&&t.subscribeTo(e.selectedInstrument,function(){n()}),n()},Data:s,OpenSelectDateDialog:function(){isDefinedType(c)&&c.open(eDialog.NewDealValueDate,i,eViewTypes.vNewDealValueDate),s.hasValueDate(!0)},OnValueDateTimeSet:function(){!isNullOrUndefined(s.valueTime)&&s.valueTime.isValid()&&(!isNullOrUndefined(e)&&isFunctionType(e.valueDate)&&(e.valueDate(function(e){if(!isNullOrUndefined(e)){var t=str2Date(e,"d/m/Y"),i=s.valueTime().split(":"),a=parseInt(i[0]),n=parseInt(i[1]),r=parseInt(i[2]);return t.setHours(a),t.setMinutes(n),t.setSeconds(r),t}}(s.valueDateStr())),s.execDateTimeString(String.format("{0} {1}",pad(s.valueDateStr(),2),pad(s.valueTime(),2)))),isDefinedType(c)&&c.close())},OnCloseDialog:o}});return{viewModel:{createViewModel:function(e){var t=new i(e);return t.Init(),t}}}}),define("webViewModels/BackOffice/CloseDealViewModel",["require","knockout","dalTransactions","extendedCloseDealSettings","InstrumentsManager","StatesManager","StateObject!Transaction","viewModels/Deals/CloseDealBaseViewModel","LoadDictionaryContent!deals_CloseDeal","LimitValuesCalculator"],function(e){var c=e("knockout"),u=e("dalTransactions"),d=e("extendedCloseDealSettings"),t=e("viewModels/Deals/CloseDealBaseViewModel"),m=e("InstrumentsManager"),f=e("StatesManager"),p=e("StateObject!Transaction"),b=e("LimitValuesCalculator"),i=extendClass(t,function(){var t=this,i=this.parent,r=this.Data,s=i.BaseOrder;function o(e,t){r.isProcessing(!0);var i={failCallback:n,hasUnwrappedItems:!t,forceRetry:!0};u.CloseDeals(e,a,i)}function a(e,t,i){r.isProcessing(!1);var a=m.GetInstrument(r.selectedInstrument()),n={requestData:i,tradingEnabledRetry:o};a&&s.OnActionReturn(e,t,a,n)}function n(){r.isProcessing(!1)}function l(e){e=e||!1,r.extendedTradingEnabled(e),r.extendedTradingRate(e?Number(r.SelectedPosition().spotRate()):0)}return{init:function(e){p.containsKey("stateObjectIsReadyDefer")||p.set("stateObjectIsReadyDefer",Q.defer()),i.init.call(t,e),r.extendedTradingEnabled=c.observable(!1),r.extendedTradingRate=c.observable(0),r.extendedTradingPL=c.observable(0),r.CloseDealReady=t.createComputed(function(){var e=!r.isProcessing(),t=!!isDefinedType(f.States.IsMarketClosed())&&f.States.IsMarketClosed(),i=!r.extendedTradingEnabled()||0<r.extendedTradingRate();return!t&&e&&r.HasPosition()&&i}),t.subscribeTo(r.SelectedPosition,function(){l(!1)}),t.subscribeTo(r.extendedTradingRate,function(){!function(){if(r.extendedTradingEnabled()){var e=b.CalculateValuesFromRate(r.SelectedPosition().dealRate,r.SelectedPosition().dealRate,r.extendedTradingRate(),r.SelectedPosition().orderDir,null,r.SelectedPosition().dealAmount,d.rangeForPLCalculation,r.quoteForOtherCcyToAccountCcy(),r.SelectedPosition().instrumentID);r.extendedTradingPL(e.hasOwnProperty("value")&&"number"==typeof e.value&&0!==e.value?e.value.toFixed(2):0)}}()}),r.extendedTradingRate.extend({toNumericLength:{ranges:[{from:0,to:Number.MAX_SAFE_INTEGER}],isAllowNAValue:!0}}),p.get("stateObjectIsReadyDefer").resolve()},Data:r,CloseDeal:function(){if(r.CloseDealReady()){r.isProcessing(!0);var e=[{positionNumber:r.SelectedPosition().positionNumber,spotRate:r.extendedTradingEnabled()?r.extendedTradingRate():r.SelectedPosition().spotRate,fwPips:r.SelectedPosition().fwPips,dealRate:r.SelectedPosition().dealRate,instrumentID:r.SelectedPosition().instrumentID}];if(!r.quoteIsActive())return o(e,!0);u.CloseDeals(e,a,{failCallback:n})}},EnableExtendedTrading:l}});return{viewModel:{createViewModel:function(){var e=new i;return e.init(d),e}}}}),define("webViewModels/BackOffice/NewDealSlipViewModel",["require","knockout","Q","newDealSettings","Dictionary","Customer","StatesManager","InstrumentsManager","ViewModelsManager","PermissionsModule","DealTypeManager","dalTransactions","FxNet/LogicLayer/Deal/DealLifeCycle","viewModels/Limits/AmountFieldsWrapper","viewModels/Deals/DealBaseViewModel","StateObject!Transaction","LoadDictionaryContent!deals_newdeal","AlertsManager"],function(e){var f=e("knockout"),p=e("Q"),a=e("newDealSettings"),b=e("Dictionary"),D=e("Customer"),T=e("dalTransactions"),v=e("StatesManager"),S=e("InstrumentsManager"),y=e("PermissionsModule"),L=e("FxNet/LogicLayer/Deal/DealLifeCycle"),w=e("viewModels/Limits/AmountFieldsWrapper"),t=e("viewModels/Deals/DealBaseViewModel"),A=e("DealTypeManager"),g=e("StateObject!Transaction"),R=e("AlertsManager"),n=extendClass(t,function(){var t,l=this,i=this.parent,c=this.Data,u=i.BaseOrder,a=new w,d=i.SetLimitsModel,n=[];function r(){a.init(d,c),l.subscribeTo(c.enableSLLimit,function(e){e||(d.Data.stopLossRate(""),d.Data.stopLossAmount(""),d.Data.stopLossPercent(""),a.Data.stopLossInCustomerCcy(""))}),l.subscribeTo(d.Data.curSlActiveTab,function(e){c.isSlRateActiveTab(e===eSetLimitsTabs.Rate),c.isSlAmountActiveTab(e===eSetLimitsTabs.Amount),c.isSlPercentActiveTab(e===eSetLimitsTabs.Percent)}),l.subscribeTo(d.Data.stopLossPercent,function(e){c.displaySlPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),l.subscribeTo(a.Data.stopLossInCustomerCcy,function(e){c.displaySlAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),l.subscribeTo(c.enableTPLimit,function(e){e||(d.Data.takeProfitRate(""),d.Data.takeProfitAmount(""),d.Data.takeProfitPercent(""),a.Data.takeProfitInCustomerCcy(""))}),l.subscribeTo(d.Data.curTpActiveTab,function(e){c.isTpRateActiveTab(e===eSetLimitsTabs.Rate),c.isTpAmountActiveTab(e===eSetLimitsTabs.Amount),c.isTpPercentActiveTab(e===eSetLimitsTabs.Percent)}),l.subscribeTo(d.Data.takeProfitPercent,function(e){c.displayTpPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),l.subscribeTo(a.Data.takeProfitInCustomerCcy,function(e){c.displayTpAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),c.limitsReady(!0),i.setLimitTabsFromClientProfile()}function s(e,t,i,a){c.hasInstrument(!0),c.isProcessing(!1);var n,r=S.GetInstrument(i),s=l.getSettings().onSuccessRedirectTo,o={requestData:a,tradingEnabledRetry:m};r&&(u.ResultStatusSuccess(e)&&(d.Data.stopLossRate(String.empty),d.Data.takeProfitRate(String.empty),c.enableSLLimit(!1),c.enableTPLimit(!1),(n=eOrderDir.None)!=eOrderDir.Buy&&n!=eOrderDir.Sell&&n!=eOrderDir.None&&(n=eOrderDir.None),c.orderDir(n)),s?u.OnActionReturn(e,t,r,extendType({redirectToView:s},o)):u.OnActionReturn(e,t,r,o))}function o(){c.isProcessing(!1)}function m(e){c.hasInstrument(!1),c.isProcessing(!0),T.OpenDeal(e,s,{forceRetry:!0,failCallback:o})}return{init:function(e){g.containsKey("stateObjectIsReadyDefer")||g.set("stateObjectIsReadyDefer",p.defer()),i.init.call(l,e),c.expirationDate=f.observable(),c.sharesDividendDate=f.observable(),c.corporateActionDate=f.observable(),c.showShareCorporateActionDealInfo=f.observable(),c.showShareDividendDealInfo=f.observable(),c.showFutureRolloverDealInfo=f.observable(""),c.futuresRolloverDate=f.observable(""),c.sellAmount=f.observable(""),c.buyAmount=f.observable(""),c.valueDate=f.observable(""),c.showLastRate=f.observable(!1),c.DealButtonEnabled=l.createComputed(function(){var e=c.selectedInstrument.isValid(),t=c.hasInstrument()&&c.limitsReady()&&c.quotesAvailable(),i=c.isShowBuyBox()||c.isShowSellBox(),a=0<c.dealMinMaxAmounts().length,n=!c.showLastRate()||0<c.sellAmount()&&0<c.buyAmount();return!c.isProcessing()&&a&&i&&n&&e&&t}),c.focusOnSlRate=l.createComputed(function(){return c.enableSLLimit()&&d.Data.curSlActiveTab()===eSetLimitsTabs.Rate}),c.focusOnSlAmount=l.createComputed(function(){return c.enableSLLimit()&&(d.Data.curSlActiveTab()===eSetLimitsTabs.Amount||d.Data.curSlActiveTab()===d.Data.defaultTab)}),c.focusOnSlPercent=l.createComputed(function(){return c.enableSLLimit()&&d.Data.curSlActiveTab()===eSetLimitsTabs.Percent}),c.focusOnTpRate=l.createComputed(function(){return c.enableTPLimit()&&d.Data.curTpActiveTab()===eSetLimitsTabs.Rate}),c.focusOnTpAmount=l.createComputed(function(){return c.enableTPLimit()&&(d.Data.curTpActiveTab()===eSetLimitsTabs.Amount||d.Data.curTpActiveTab()===d.Data.defaultTab)}),c.focusOnTpPercent=l.createComputed(function(){return c.enableTPLimit()&&d.Data.curTpActiveTab()===eSetLimitsTabs.Percent}),t=l.createComputed(function(){return c.selectedInstrument()}),l.subscribeAndNotify(t,function(e){var t=S.GetInstrument(e);t&&(i.setLimitTabsFromClientProfile(),c.expirationDate(t.expirationDate),c.sharesDividendDate(str2Date(t.eventDate,"d/m/Y H:M")),c.corporateActionDate(str2Date(t.getCorporateActionDate(),"d/m/Y H:M")),c.futuresRolloverDate(str2Date(t.eventDate,"d/m/Y H:M")),c.showShareCorporateActionDealInfo(L.sharesIsCorporateActionDateSignificant_BeforeDeal(D.prop.dealPermit,t.assetTypeId,t.getCorporateActionDate())),c.showShareDividendDealInfo(L.sharesIsDividendDateSignificant_BeforeDeal(D.prop.dealPermit,t.assetTypeId,t.getCorporateActionDate(),t.getInstrumentDividendDate())),c.showFutureRolloverDealInfo(L.futuresIsRolloverDateSignificant_BeforeDeal(D.prop.dealPermit,t.assetTypeId,t.getInstrumentRolloverDate()))),A.Init(),t.isFuture?A.ConsumeEvent("future"):t.isShare?A.ConsumeEvent("share"):A.ConsumeEvent()}),l.subscribeTo(c.showLastRate,function(e){e?(c.sellAmount(c.bid()),c.buyAmount(c.ask()),function(){i.unRegisterFromDispatcher();var e=l.subscribeTo(c.sellAmount,function(e){c.bid(e)}),t=l.subscribeTo(c.buyAmount,function(e){c.ask(e)});n.push(e,t)}()):(i.registerToDispatcher(),n.forEach(function(e){e.dispose(),n.pop(e)}))}),l.subscribeTo(c.orderDir,function(){c.showLastRate(!1)}),c.selectedInstrument.extend({validation:{validator:function(e){return isEmptyValue(e)||!v.States.IsMarketClosed()},message:b.GetItem("InstrumentInactive")}}),c.sellAmount.extend({toNumericLength:{ranges:[{from:0,to:Number.MAX_SAFE_INTEGER}],isAllowNAValue:!0},amountValidation:0<c.dealMinMaxAmounts().length}),c.buyAmount.extend({toNumericLength:{ranges:[{from:0,to:Number.MAX_SAFE_INTEGER}],isAllowNAValue:!0},amountValidation:0<c.dealMinMaxAmounts().length}),c.selectedInstrument.extend({tooltipValidation:{notify:"always"}}),i.registerToDispatcher(),d.Start(r),d.SetSlActiveTab(eSetLimitsTabs.Rate),d.SetTpActiveTab(eSetLimitsTabs.Rate),g.get("stateObjectIsReadyDefer").resolve()},dispose:function(){d.Stop(),a.dispose(),a=null,i.dispose.call(l)},Data:c,BaseOrder:u,DealButtonHandler:function(){c.DealButtonEnabled()&&y.CheckActionAllowed("newDeal",!0,{register:registerParams.traderInstrumentId+c.selectedInstrument()+registerParams.traderOrderDir+(0===c.orderDir()?"Sell":"Buy")})&&(isFunctionType(c.selectedDealAmount.isValid)&&c.selectedDealAmount.isValid()?function(){var e=new TDeal,t=0<c.sellAmount()&&!0===c.showLastRate()?c.sellAmount():c.activeQuote.bid,i=0<c.buyAmount()&&!0===c.showLastRate()?c.buyAmount():c.activeQuote.ask,a=!1,n=!1;if(e.dealType=A.GetStatus(),e.instrumentID=c.selectedInstrument(),e.amount=c.selectedDealAmount(),e.marketRate=c.orderDir()===eOrderDir.Sell?t:i,e.otherRateSeen=c.orderDir()===eOrderDir.Sell?i:t,e.orderDir=c.orderDir(),e.slRate=0,e.tpRate=0,e.expirationDate=c.expirationDate(),e.execDate=isEmptyValue(c.valueDate())?null:c.valueDate().ExtractDate()+" "+c.valueDate().ExtractFullTime(),c.enableSLLimit()&&(e.slRate=""===d.Data.stopLossRate()?0:d.Data.stopLossRate(),a="NA"===e.slRate),c.enableTPLimit()&&(e.tpRate=""===d.Data.takeProfitRate()?0:d.Data.takeProfitRate(),n="NA"===e.tpRate),a||n){var r=b.GetItem("txtRateValidationTooltip").split(".");return R.UpdateAlert(AlertTypes.GeneralOkAlert,b.GetItem("pleaseNoteTitle"),r.length?r[0]:"",null,{}),R.PopAlert(AlertTypes.GeneralOkAlert)}c.hasInstrument(!1),c.isProcessing(!0),T.OpenDeal(e,s)}():f.postbox.publish("deal-slip-show-validation-tooltips"))},ShowLastRate:function(e){c.showLastRate(e)},TPField:d.TPField,SLField:d.SLField,SetLimitsInfo:d.ObservableSetLimitsObject,SetLimitsViewProperties:d.ViewProperties,FieldWrappers:a}});return{viewModel:{createViewModel:function(e){var t=new n,i=$.extend(a,e);return t.init(i),t}}}}),define("webViewModels/BackOffice/NewLimitViewModel",["require","knockout","Q","newLimitSettings","dalTransactions","Customer","PermissionsModule","InstrumentsManager","FxNet/LogicLayer/Deal/DealLifeCycle","viewModels/Limits/AmountFieldsWrapper","viewModels/Limits/LimitBaseViewModel","StateObject!Transaction","LoadDictionaryContent!deals_newlimit","Dictionary","AlertsManager"],function(e){var p=e("knockout"),a=e("newLimitSettings"),b=e("Q"),D=e("dalTransactions"),T=e("Customer"),v=e("PermissionsModule"),S=e("InstrumentsManager"),y=e("FxNet/LogicLayer/Deal/DealLifeCycle"),L=e("viewModels/Limits/AmountFieldsWrapper"),t=e("viewModels/Limits/LimitBaseViewModel"),w=e("StateObject!Transaction"),A=e("Dictionary"),g=e("AlertsManager"),n=extendClass(t,function(){var t,o=this,i=this.parent,l=this.Data,a=new L,c=i.BaseOrder,s=i.ExpirationDate,n=i.SetLimitsModel;function r(){var e;a.init(n,l),o.subscribeTo(l.enableSLLimit,function(e){e||(n.Data.stopLossRate(""),n.Data.stopLossAmount(""),n.Data.stopLossPercent(""),a.Data.stopLossInCustomerCcy(""))}),o.subscribeTo(n.Data.curSlActiveTab,function(e){l.isSlRateActiveTab(e===eSetLimitsTabs.Rate),l.isSlAmountActiveTab(e===eSetLimitsTabs.Amount),l.isSlPercentActiveTab(e===eSetLimitsTabs.Percent)}),o.subscribeTo(n.Data.stopLossPercent,function(e){l.displaySlPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),o.subscribeTo(a.Data.stopLossInCustomerCcy,function(e){l.displaySlAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),o.subscribeTo(l.enableTPLimit,function(e){e||(n.Data.takeProfitRate(""),n.Data.takeProfitAmount(""),n.Data.takeProfitPercent(""),a.Data.takeProfitInCustomerCcy(""))}),o.subscribeTo(n.Data.curTpActiveTab,function(e){l.isTpRateActiveTab(e===eSetLimitsTabs.Rate),l.isTpAmountActiveTab(e===eSetLimitsTabs.Amount),l.isTpPercentActiveTab(e===eSetLimitsTabs.Percent)}),o.subscribeTo(n.Data.takeProfitPercent,function(e){l.displayTpPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),o.subscribeTo(a.Data.takeProfitInCustomerCcy,function(e){l.displayTpAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),l.limitsReady(!0),e=eSetLimitsTabs.Rate,n.Data.curSlActiveTab(e),n.Data.curTpActiveTab(e)}function u(){var e;l.openLimit(String.empty),(e=eOrderDir.None)!=eOrderDir.Buy&&e!=eOrderDir.Sell&&e!=eOrderDir.None&&(e=eOrderDir.None),l.orderDir(e),n.Data.stopLossRate(String.empty),n.Data.takeProfitRate(String.empty),l.enableSLLimit(!1),l.enableTPLimit(!1)}function d(e,t,i,a){l.hasInstrument(!0),l.isProcessing(!1);var n=S.GetInstrument(i),r=o.getSettings().onSuccessRedirectTo,s={requestData:a,tradingEnabledRetry:f};n&&(c.ResultStatusSuccess(e)&&u(),r?c.OnActionReturn(e,t,n,extendType({redirectToView:r},s)):c.OnActionReturn(e,t,n,s))}function m(){l.isProcessing(!1)}function f(e){l.hasInstrument(!1),l.isProcessing(!0),D.AddLimit(e,d,{forceRetry:!0,failCallback:m})}return{init:function(e){w.containsKey("stateObjectIsReadyDefer")||w.set("stateObjectIsReadyDefer",b.defer()),i.init.call(o,e),l.sharesDividendDate=p.observable(),l.corporateActionDate=p.observable(),l.showShareCorporateActionDealInfo=p.observable(),l.showShareDividendDealInfo=p.observable(),l.showFutureRolloverDealInfo=p.observable(""),l.futuresRolloverDate=p.observable(""),l.selectedInstrument.extend({validatable:!1}),l.selectedInstrument.extend({validation:{validator:function(e){var t=T.prop.brokerAllowLimitsOnNoRates;return isEmptyValue(e)||t},message:A.GetItem("InstrumentInactive")}}),l.selectedInstrument.extend({tooltipValidation:{notify:"always"}}),l.focusOnSlRate=o.createComputed(function(){return l.enableSLLimit()&&n.Data.curSlActiveTab()===eSetLimitsTabs.Rate}),l.focusOnSlAmount=o.createComputed(function(){return l.enableSLLimit()&&(n.Data.curSlActiveTab()===eSetLimitsTabs.Amount||n.Data.curSlActiveTab()===n.Data.defaultTab)}),l.focusOnSlPercent=o.createComputed(function(){return l.enableSLLimit()&&n.Data.curSlActiveTab()===eSetLimitsTabs.Percent}),l.focusOnTpRate=o.createComputed(function(){return l.enableTPLimit()&&n.Data.curTpActiveTab()===eSetLimitsTabs.Rate}),l.focusOnTpAmount=o.createComputed(function(){return l.enableTPLimit()&&(n.Data.curTpActiveTab()===eSetLimitsTabs.Amount||n.Data.curTpActiveTab()===n.Data.defaultTab)}),l.focusOnTpPercent=o.createComputed(function(){return l.enableTPLimit()&&n.Data.curTpActiveTab()===eSetLimitsTabs.Percent}),l.OrderButtonEnabled=o.createComputed(function(){var e=l.hasInstrument()&&l.limitsReady()&&l.quotesAvailable(),t=0<l.openLimit(),i=T.prop.brokerAllowLimitsOnNoRates,a=s.IsValid(),n=l.isShowBuyBox()||l.isShowSellBox(),r=0<l.dealMinMaxAmounts().length;return!l.isProcessing()&&i&&n&&e&&t&&a&&r}),t=o.createComputed(function(){return l.selectedInstrument()}),o.subscribeAndNotify(t,function(e){var t=S.GetInstrument(e);t&&(l.sharesDividendDate(str2Date(t.eventDate,"d/m/Y H:M")),l.corporateActionDate(str2Date(t.getCorporateActionDate(),"d/m/Y H:M")),l.futuresRolloverDate(str2Date(t.eventDate,"d/m/Y H:M")),l.showShareCorporateActionDealInfo(y.sharesIsCorporateActionDateSignificant_BeforeDeal(T.prop.dealPermit,t.assetTypeId,t.getCorporateActionDate())),l.showShareDividendDealInfo(y.sharesIsDividendDateSignificant_BeforeDeal(T.prop.dealPermit,t.assetTypeId,t.getCorporateActionDate(),t.getInstrumentDividendDate())),l.showFutureRolloverDealInfo(y.futuresIsRolloverDateSignificant_BeforeDeal(T.prop.dealPermit,t.assetTypeId,t.getInstrumentRolloverDate())))}),i.registerToDispatcher(),n.Start(r),w.get("stateObjectIsReadyDefer").resolve()},dispose:function(){n.Stop(),a.dispose(),a=null,i.dispose.call(o)},Data:l,BaseOrder:c,OrderButtonHandler:function(){l.OrderButtonEnabled()&&v.CheckActionAllowed("newLimit",!0,{register:registerParams.traderInstrumentId+l.selectedInstrument()+registerParams.traderOrderDir+(0===l.orderDir()?"Sell":"Buy")})&&(isFunctionType(l.selectedDealAmount.isValid)&&l.selectedDealAmount.isValid()?c.LimitValidateQuote(l.selectedInstrument())&&function(){var e=new TLimit;if(i.fillData(e),"NA"===e.ifDoneSLRate||"NA"===e.ifDoneTPRate){var t=A.GetItem("txtRateValidationTooltip").split(".");return g.UpdateAlert(AlertTypes.GeneralOkAlert,A.GetItem("pleaseNoteTitle"),t.length?t[0]:"",null,{}),g.PopAlert(AlertTypes.GeneralOkAlert)}l.isProcessing(!0),l.hasInstrument(!1),D.AddLimit(e,d)}():p.postbox.publish("deal-slip-show-validation-tooltips"))},ExpirationDate:s,TPField:n.TPField,SLField:n.SLField,SetLimitsInfo:n.ObservableSetLimitsObject,LimitLevelField:i.LimitLevelField,FieldWrappers:a}});return{viewModel:{createViewModel:function(e){var t=new n,i=$.extend(a,e);return t.init(i),t}}}}),define("webViewModels/BackOffice/EditLimitViewModel",["require","editLimitSettings","Dictionary","StateObject!Transaction","viewModels/Limits/EditLimitBaseViewModel","ActiveLimitsManager","ViewsManager","DialogViewModel","LoadDictionaryContent!deals_EditLimit","InstrumentsManager","BaseOrder","dalTransactions","AlertsManager"],function(e){var t=e("editLimitSettings"),S=e("Dictionary"),y=e("StateObject!Transaction"),i=e("viewModels/Limits/EditLimitBaseViewModel"),L=e("ActiveLimitsManager"),w=e("ViewsManager"),a=e("DialogViewModel"),A=e("InstrumentsManager"),g=e("BaseOrder"),R=e("dalTransactions"),O=e("AlertsManager"),I=null,n=extendClass(i,function(){var t=this,a=this.parent,o=this.Data,l=a.ExpirationDate,i=a.FieldWrappers,r=a.SetLimitsViewModel,s=new g,n=function(){o.EditLimitReady=t.createComputed(function(){var e=o.openLimit.isDirty(),t=!!o.setLimitsIsDirty(),i=l.Data.isExpirationDateDirty(),a=o.openLimit&&0<o.openLimit(),n=e||t||i,r=o.onSaveLimitEnable(),s=l.IsValid();return r&&s&&n&&a}).extend({notify:"always"})},e=debounce(function(){o.EditLimitReady()&&function(){if(D()&&(I=L.limits.GetItem(w.GetViewArgs(eViewTypes.vEditLimit).orderId),s.LimitValidateWithoutTradingStatus(I.instrumentID)&&s.LimitValidateQuote(I.instrumentID))){var e=new TLimit(I.orderID),t={failCallback:m};if(a.FillLimitData(e),"NA"===e.ifDoneSLRate||"NA"===e.ifDoneTPRate){var i=S.GetItem("txtRateValidationTooltip").split(".");return O.UpdateAlert(AlertTypes.GeneralOkAlert,S.GetItem("pleaseNoteTitle"),i.length?i[0]:"",null,{}),O.PopAlert(AlertTypes.GeneralOkAlert)}e.removedIfDoneSLRate=0==parseFloat(e.ifDoneSLRate)&&0<parseFloat(I.slRate),e.removedIfDoneTPRate=0==parseFloat(e.ifDoneTPRate)&&0<parseFloat(I.tpRate),o.onSaveLimitEnable(!1),o.isProcessing(!0),R.EditLimit(e,b,t)}}()}),c=function(){if(o.onRemoveLimitEnable()&&D()&&(I=L.limits.GetItem(w.GetViewArgs(eViewTypes.vEditLimit).orderId),s.LimitValidateWithoutTradingStatus(I.instrumentID)&&s.LimitValidateQuote(I.instrumentID))){var e=new TLimit(I.orderID),t={failCallback:f};a.FillLimitData(e),o.isProcessing(!0),o.onRemoveLimitEnable(!1),R.DeleteLimit(e,u,t)}};function u(e,t,i){o.onRemoveLimitEnable(!0),o.isProcessing(!1);var a=A.GetInstrument(o.instrumentID());a&&s.OnActionReturn(e,t,a,{redirectToView:eForms.Limits,requestData:i})}var d=function(){a.EditLimit=e,a.DeleteLimit=c};function m(){o.isProcessing(!1)}function f(){o.onRemoveLimitEnable(!0)}function p(e){var t={forceRetry:!0,failCallback:m,parsedData:!0};R.EditLimit(e,b,t)}function b(e,t,i){o.onSaveLimitEnable(!0),I=L.limits.GetItem(w.GetViewArgs(eViewTypes.vEditLimit).orderId);var a=A.GetInstrument(I.instrumentID),n={requestData:i,tradingEnabledRetry:p};a&&(o.isProcessing(!1),r.MarkClean(),s.OnActionReturn(e,t,a,extendType({redirectToView:eForms.Limits},n)))}function D(){return!!(I=L.limits.GetItem(w.GetViewArgs(eViewTypes.vEditLimit).orderId))||(O.UpdateAlert(AlertTypes.ServerResponseAlert,null,String.format("{0}",Dictionary.GetItem("OrderError7")),null,{redirectToView:eForms.Limits}),O.PopAlert(AlertTypes.ServerResponseAlert),!1)}var T=function(e){r.SetSlActiveTab(e),r.SetTpActiveTab(e)},v=function(){t.subscribeTo(o.enableSLLimit,function(e){e||(r.Data.stopLossRate(""),r.Data.stopLossAmount(""),r.Data.stopLossPercent(""),i.Data.stopLossInCustomerCcy(""))}),t.subscribeTo(r.Data.curSlActiveTab,function(e){o.isSlRateActiveTab(e===eSetLimitsTabs.Rate),o.isSlAmountActiveTab(e===eSetLimitsTabs.Amount),o.isSlPercentActiveTab(e===eSetLimitsTabs.Percent)}),t.subscribeTo(r.Data.stopLossPercent,function(e){o.displaySlPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(i.Data.stopLossInCustomerCcy,function(e){o.displaySlAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(o.enableTPLimit,function(e){e||(r.Data.takeProfitRate(""),r.Data.takeProfitAmount(""),r.Data.takeProfitPercent(""),i.Data.takeProfitInCustomerCcy(""))}),t.subscribeTo(r.Data.curTpActiveTab,function(e){o.isTpRateActiveTab(e===eSetLimitsTabs.Rate),o.isTpAmountActiveTab(e===eSetLimitsTabs.Amount),o.isTpPercentActiveTab(e===eSetLimitsTabs.Percent)}),t.subscribeTo(r.Data.takeProfitPercent,function(e){o.displayTpPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(i.Data.takeProfitInCustomerCcy,function(e){o.displayTpAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),o.limitsReady(!0)};return{init:function(e){y.containsKey("stateObjectIsReadyDefer")||y.set("stateObjectIsReadyDefer",Q.defer()),a.init.call(t,e),s.Init({},o),n(),d(),r.Start(v),T(eSetLimitsTabs.Rate),y.get("stateObjectIsReadyDefer").resolve()},Data:o,dispose:function(){a.dispose.call(t)}}});return{viewModel:{createViewModel:function(){if(null==(I=L.limits.GetItem(w.GetViewArgs(eViewTypes.vEditLimit).orderId)))return O.UpdateAlert(AlertTypes.ServerResponseAlert,S.GetItem("GenericAlert"),S.GetItem("OrderError7")),O.PopAlert(AlertTypes.ServerResponseAlert),a.close(),{_valid:!1};var e=new n;return e.init(t),e}}}}),define("webViewModels/BackOffice/EditClosingLimitViewModel",["require","knockout","editClosingLimitSettings","ActiveLimitsManager","StateObject!Transaction","viewModels/Deals/EditClosingLimitBaseViewModel","LoadDictionaryContent!deals_EditClosingLimit","DealsManager","StatesManager","InstrumentsManager","BaseOrder","dalTransactions"],function(e){var T=e("knockout"),v=e("editClosingLimitSettings"),S=e("ActiveLimitsManager"),y=e("StateObject!Transaction"),t=e("viewModels/Deals/EditClosingLimitBaseViewModel"),L=e("DealsManager"),w=e("StatesManager"),A=e("InstrumentsManager"),g=e("BaseOrder"),R=e("dalTransactions"),i=extendClass(t,function(){var t=this,n=this.parent,l=this.Data,r=n.ExpirationDate,s=n.SetLimitsModel,c=new g,i=function(){l.enableSLLimit=T.observable(!1),l.enableTPLimit=T.observable(!1)},a=function(){l.UpdateButtonEnabled=t.createComputed(function(){var e=l.setLimitsIsDirty(),t=l.limitsReady(),i=l.isProcessing(),a=r.Data.isExpirationDateDirty(),n=!isNullOrUndefined(l.closingLimit());return t&&!i&&(e||a&&n)}),l.focusOnSlRate=t.createComputed(function(){return s.Data.curSlActiveTab()===eSetLimitsTabs.Rate}),l.focusOnTpRate=t.createComputed(function(){return s.Data.curTpActiveTab()===eSetLimitsTabs.Rate})},o=function(){var e;(n.updateViewModelData(),l.selectedDeal())&&(e=l.limitType()===eLimitType.StopLoss?l.selectedDeal().slID:l.selectedDeal().tpID,l.closingLimit(S.limits.GetItem(e)),isNullOrUndefined(l.closingLimit())||isEmptyValue(l.closingLimit().expirationDate)||r.SetOrder(e))},u=function(){e(),t.subscribeTo(s.Data.stopLossPercent,function(e){l.displaySlPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(l.stopLossInCustomerCcy,function(e){l.displaySlAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(s.Data.takeProfitPercent,function(e){l.displayTpPercentSymbol(!isEmptyValue(e)&&"NA"!==e)}),t.subscribeTo(l.takeProfitInCustomerCcy,function(e){l.displayTpAmountCcySymbol(!isEmptyValue(e)&&"NA"!==e)}),l.limitsReady(!0)},e=function(){var i=T.observable(""),a=T.observable("");t.subscribeTo(s.Data.ccySLAmount,function(e){s.Data.curSlActiveTab()===eSetLimitsTabs.Amount||i(e)}),l.stopLossInCustomerCcy=t.createComputed({read:function(){var e,t="";return"NA"===(e=s.Data.curSlActiveTab()===eSetLimitsTabs.Amount?i():s.Data.ccySLAmount())?e:(""===e||isNaN(e)||(t=(t=Number(e))<0?Math.floor(t):Math.ceil(t)),t)}}),t.subscribeTo(s.Data.ccyTPAmount,function(e){s.Data.curTpActiveTab()===eSetLimitsTabs.Amount||a(e)}),l.takeProfitInCustomerCcy=t.createComputed({read:function(){var e,t="";return"NA"===(e=s.Data.curTpActiveTab()===eSetLimitsTabs.Amount?a():s.Data.ccyTPAmount())?e:(""===e||isNaN(e)||(t=(t=Number(e))<0?Math.floor(t):Math.ceil(t)),t)}})},d=function(){if(l.hasRateAdded()){if(l.limitType()===eLimitType.StopLoss)s.Data.stopLossRate("");else{if(l.limitType()!==eLimitType.TakeProfit)return;s.Data.takeProfitRate("")}f()}},m=function(e){var t={forceRetry:!0,failCallback:p};R.SaveLimits(e,D,t)},f=debounce(function(){var e,t=L.Deals.GetItem(l.orderID());if(1==w.States.fxDenied())return c.ValidateOnlineTradingUser(),!1;if(isNullOrUndefined(t))return e="OrderError8",AlertsManager.UpdateAlert(AlertTypes.ServerResponseAlert,null,Dictionary.GetItem(e),null,{redirectToView:eForms.OpenDeals}),void AlertsManager.PopAlert(AlertTypes.ServerResponseAlert);var i=n.FillLimitsData(),a={failCallback:p};!isNullOrUndefined(i)&&0<i.length&&(l.isProcessing(!0),R.SaveLimits(i,D,a))},300,!0),p=function(){l.isProcessing(!1)},b=function(){n.EditLimit=f,n.DeleteLimit=d};function D(e,t,i,a){var n=L.Deals.GetItem(l.orderID());if(n){var r=A.GetInstrument(n.instrumentID);if(r){l.isProcessing(!1);var s={},o={requestData:a,tradingEnabledRetry:m};v.redirectToOpenDeals&&(s.redirectToView=eForms.OpenDeals),"valueDate"in n&&(s.valueDate=n.valueDate),c.OnActionReturn(e,t,r,extendType(s,o))}}}return{init:function(e){y.containsKey("stateObjectIsReadyDefer")||y.set("stateObjectIsReadyDefer",Q.defer()),n.init.call(t,e),i(),a(),b(),o(),s.Start(u),y.get("stateObjectIsReadyDefer").resolve()},dispose:function(){n.dispose.call(t)},Data:l,TPField:s.TPField,SLField:s.SLField,SetLimitsInfo:s.Data,SetLimitsViewProperties:s.ViewProperties}});return{viewModel:{createViewModel:function(){var e=new i;return e.init(v),e}}}}),define("dalTransactions",function(){var f=timeStamp(),p=function(e,t){var i,a=JSONHelper.STR2JSON("dalOreder:analyzeResponse",e);if(!a)return[{status:0,msgKey:"OrderError1",itemId:"",arguments:null}];a.arguments=null,a.length||(a=[a]);for(var n=0,r=a.length;n<r;n++){var s=a[n];o(s,isDefinedType(t)?t:s.action),s.arguments=null,s.responseArgumentsJson&&(i=JSONHelper.STR2JSON("dalOreder:analyzeResponse",s.responseArgumentsJson),Array.isArray(i)?s.arguments=i:(s.arguments=[],s.arguments.push(i)))}return a},o=function(e,t){e.status==eResult.Success?t==eOrderActionType.NewLimit?e.msgKey="SuccessLimitAdd":t==eOrderActionType.EditLimit?e.msgKey="SuccessLimitEdit":t==eOrderActionType.DeleteLimit?e.msgKey="SuccessLimitDelete":t==eOrderActionType.NewDeal?e.msgKey="SuccessDealAdd":t==eOrderActionType.CloseDeal&&(e.msgKey="SuccessDealClose"):e.msgKey=e.result};return{OpenDeal:function(a,n,e){var t=new TAjaxer,i=!(!e||!e.hasOwnProperty("forceRetry"))&&e.forceRetry,r=e&&e.hasOwnProperty("failCallback")&&"function"==typeof e.failCallback?e.failCallback:null;f=timeStamp();var s={DealType:a.dealType,InstrumentId:a.instrumentID,Amount:a.amount,MarketRate:a.marketRate,OtherRateSeen:a.otherRateSeen,OrderDirection:a.orderDir,TakeProfitRate:a.tpRate,StopLossRate:a.slRate,SecurityToken:a.securityToken,ExecDate:a.execDate};i&&(s.Retry=1),t.promises.jsonPost("dalTransactions/openDeal","api/backoffice/transactions/opendeal",JSON.stringify(s)).then(function(e){var t=eOrderAction.NewDeal,i=p(e,eOrderActionType.NewDeal);n(i,t,a.instrumentID,a)}).fail(function(e){ErrorManager.onError("dalTransactions/openDeal",e.message,eErrorSeverity.medium),r&&r()})},AddLimit:function(a,n,e){var t=new TAjaxer,i=!(!e||!e.hasOwnProperty("forceRetry"))&&e.forceRetry,r=e&&e.hasOwnProperty("failCallback")&&"function"==typeof e.failCallback?e.failCallback:null;f=timeStamp();i&&(a.retry=1),t.promises.jsonPost("dalTransactions/addLimit","api/backoffice/transactions/addlimit",JSON.stringify(a)).then(function(e){var t=eOrderAction.NewLimit,i=p(e,eOrderActionType.NewLimit);n(i,t,a.instrumentID,a)}).fail(function(e){ErrorManager.onError("dalTransactions/addLimit",e.message,eErrorSeverity.medium),r&&r()})},CloseDeals:function(e,a,t){var i,n=new TAjaxer,r=t&&t.hasOwnProperty("forceRetry")&&t.forceRetry,s=!(!t||!t.hasOwnProperty("hasUnwrappedItems"))&&t.hasUnwrappedItems,o=t&&t.hasOwnProperty("failCallback")&&"function"==typeof t.failCallback?t.failCallback:null,l=s?e:[],c=[],u="api/backoffice/transactions/closedeals?retry="+(r?1:0);f=timeStamp();for(var d=0,m=e.length;d<m;d++)s||(l[d]=ko.toJS(e[d])),c.push(String.format("{0}#{1}#{2}",l[d].positionNumber,l[d].spotRate,l[d].fwPips));i=c.join("_"),n.promises.jsonPost("dalTransactions/closeDeals",u,JSON.stringify(i)).then(function(e){var t=eOrderAction.CloseDeal,i=p(e,eOrderActionType.CloseDeal);a&&a(i,t,l)}).fail(function(e){ErrorManager.onError("dalTransactions/closeDeals",e.message,eErrorSeverity.medium),o&&o()})},EditLimit:function(a,n,e){f=timeStamp();var t=new TAjaxer,i=e&&e.hasOwnProperty("forceRetry")&&e.forceRetry,r=e&&e.hasOwnProperty("failCallback")&&"function"==typeof e.failCallback?e.failCallback:null;i&&extendType(a,{retry:1});t.promises.jsonPost("dalTransactions/editLimit","api/backoffice/transactions/editlimit",JSON.stringify(a)).then(function(e){var t=eOrderAction.EditLimit,i=p(e,eOrderActionType.EditLimit);n(i,t,a)}).fail(function(e){ErrorManager.onError("dalTransactions/editLimit",e.message,eErrorSeverity.medium),r&&r()})},SaveLimits:function(a,n,e){f=timeStamp();var t=new TAjaxer,i=e&&e.hasOwnProperty("forceRetry")&&e.forceRetry,r=e&&e.hasOwnProperty("failCallback")&&"function"==typeof e.failCallback?e.failCallback:null;i&&a.map(function(e){extendType(e,{retry:1})});t.promises.jsonPost("dalTransactions/editLimit","api/backoffice/transactions/savelimits",JSON.stringify(a)).then(function(e){var t=eOrderAction.SaveLimits,i=p(e);n(i,t,null,a)}).fail(function(e){ErrorManager.onError("dalTransactions/saveLimits",e.message,eErrorSeverity.medium),r&&r()})},DeleteLimit:function(a,n,e){var t=new TAjaxer,i=e&&e.hasOwnProperty("failCallback")&&"function"==typeof e.failCallback?e.failCallback:null;f=timeStamp();t.promises.jsonPost("dalTransactions/deleteLimit","api/backoffice/transactions/deletelimit",JSON.stringify(a)).then(function(e){var t=eOrderAction.DeleteLimit,i=p(e,eOrderActionType.DeleteLimit);n(i,t,a)}).fail(function(e){ErrorManager.onError("dalTransactions/deleteLimit",e.message,eErrorSeverity.medium),i&&i()})},lastTimeRequest:function(){return f},resetTimeRequest:function(){f=timeStamp()}}});
//# sourceMappingURL=enabletrading.js.map